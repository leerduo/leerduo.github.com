<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="UI/UE,移动开发," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="这部分的主要内容是创建向后兼容的UI。展示了如何以向后兼容的方式使用在新版本的Android上可用的UI组件和API，确保你的应用在之前的版本上依然能够运行。贯穿整个课程，在Android 3.0被新引入的Action Bar Tabs功能在本课程中作为指导例子，但是你可以在其他UI组件和API功能上运用这种方式。主要内容包括一下几点：


抽象出新的APIs
代理至新的APIs
使用旧的APIs">
<meta property="og:type" content="article">
<meta property="og:title" content="training for the tenth part">
<meta property="og:url" content="http://chenfuduo.me/2015/07/01/training-for-the-tenth-part/index.html">
<meta property="og:site_name" content="chenfuduo">
<meta property="og:description" content="这部分的主要内容是创建向后兼容的UI。展示了如何以向后兼容的方式使用在新版本的Android上可用的UI组件和API，确保你的应用在之前的版本上依然能够运行。贯穿整个课程，在Android 3.0被新引入的Action Bar Tabs功能在本课程中作为指导例子，但是你可以在其他UI组件和API功能上运用这种方式。主要内容包括一下几点：


抽象出新的APIs
代理至新的APIs
使用旧的APIs">
<meta property="og:image" content="http://1.infotravel.sinaapp.com/pic/backward-compatible-ui-classes.png">
<meta property="og:image" content="http://1.infotravel.sinaapp.com/pic/backward-compatible-ui-classes-honeycomb.png">
<meta property="og:image" content="http://1.infotravel.sinaapp.com/pic/backward-compatible-ui-gb.png">
<meta property="og:image" content="http://1.infotravel.sinaapp.com/pic/backward-compatible-ui-ics.png">
<meta property="og:updated_time" content="2015-07-01T13:04:28.819Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="training for the tenth part">
<meta name="twitter:description" content="这部分的主要内容是创建向后兼容的UI。展示了如何以向后兼容的方式使用在新版本的Android上可用的UI组件和API，确保你的应用在之前的版本上依然能够运行。贯穿整个课程，在Android 3.0被新引入的Action Bar Tabs功能在本课程中作为指导例子，但是你可以在其他UI组件和API功能上运用这种方式。主要内容包括一下几点：


抽象出新的APIs
代理至新的APIs
使用旧的APIs">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> training for the tenth part | chenfuduo </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?63c029dba1e367df2c8ffa39a309056a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">chenfuduo</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">纸上得来终觉浅,绝知此事要躬行。</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-heartbeat fa-fw"></i> <br />
            
            公益404
          </a>
        </li>
      

      
      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                training for the tenth part
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-07-01T15:21:23+08:00" content="2015-07-01">
              2015-07-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/移动开发/" itemprop="url" rel="index">
                    <span itemprop="name">移动开发</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2015/07/01/training-for-the-tenth-part/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2015/07/01/training-for-the-tenth-part/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>这部分的主要内容是<code>创建向后兼容的UI</code>。展示了如何以向后兼容的方式使用在新版本的Android上可用的UI组件和API，确保你的应用在之前的版本上依然能够运行。<br>贯穿整个课程，在Android 3.0被新引入的Action Bar Tabs功能在本课程中作为指导例子，但是你可以在其他UI组件和API功能上运用这种方式。<br>主要内容包括一下几点：</p>
<blockquote>
<ul>
<li>抽象出新的APIs</li>
<li>代理至新的APIs</li>
<li>使用旧的APIs实现新API的效果</li>
<li>使用能感知版本的组件</li>
</ul>
</blockquote>
<a id="more"></a>
<p>#抽象出新的APIs<br>假如你想使用Action Bar Tabs作为你的应用的顶层导航的主要形式。不幸的是，ActionBar APIs只在Android 3.0（API等级11）之后才能使用。因此，如果你想要在运行之前版本的Android平台的设备上分发你的应用，你需要提供一个支持新的API的实现，同时提供一个回退机制，使得能够使用旧的APIs。(Suppose you want to use action bar tabs as the primary form of top-level navigation in your application. Unfortunately, the ActionBar APIs are only available in Android 3.0 or later (API level 11+). Thus, if you want to distribute your application to devices running earlier versions of the platform, you need to provide an implementation that supports the newer API while providing a fallback mechanism that uses older APIs.)<br>在本课程中，使用了具有面向特定版本实现的抽象类去构建一个tab页形式的用户界面，并以此提供向后兼容性。这一课描述了如何为新的tab API创建一个抽象层，并以此作为构建tab组件的第一步。</p>
<p>##为抽象做准备<br>在Java编程语言中，抽象包含了创建一个或者多个接口或抽象类去隐藏具体的实现细节。在新版本的Android API的情况中，你<code>可以使用抽象去构建能感知版本的组件</code>，<code>这个组件会在新版本的设备上使用当前的APIs</code>，<code>当回退到老的设备上同时存在兼容的APIs。</code><br>当使用这种方法时，你首先需要决定哪些要使用的类需要提供向后兼容，然后去根据新类中的public接口去创建抽象类。在创建抽象接口的过程中，你应该尽可能多的为新APIs创建镜像。(you should mirror the newer API as much as possible. )这会最大化前向兼容性，使得在将来当这些接口不再需要的时候，废弃这些接口会更加容易。<br>在为新的APIs创建抽象类之后，任何数量的实现都可以在运行的过程中去创建和选择使用哪种。出于后向兼容的目的，这些实现可以通过所需的API级别而有所变化。一个实现可能会使用最新发布的APIs，而其他的则会去使用比较老的APIs。</p>
<p>##创建抽象的Tab接口<br>为了能够创建一个向后兼容的tabs，你首先需要决定你的应用需要哪些功能和哪些特定的APIs接口。在顶层分节tabs的情况下，假设你有以下功能需求：</p>
<ul>
<li>显示图标和文本的Tab指示器</li>
<li>Tabs可以跟一个Fragment实例向关联</li>
<li>Activity可以监听到Tab变化<br>提前准备这些需求能够让你控制抽象层的范围。这意味着你可以花更少的时间去创建抽象层的多个具体实现，并很快就能使用这些新的后向兼容的实现。<br>Tabs的关键APIs是<code>ActionBar</code>和<code>ActionBar.Tab</code>，为了能够使得tab能够感知Android版本，这些是需要抽象出来的APIs。这个示例项目的需求要求同Eclair(API等级5)保持一致性，同时能够利用Honeycomb(API等级11)中新的tab功能。一张展示能够支持这两种实现的类结构和它们的抽象父类的图显示如下：<br><img src="http://1.infotravel.sinaapp.com/pic/backward-compatible-ui-classes.png" alt="抽象基类和版本相关的子类实现类结构图"><br>##Abstract ActionBar.Tab<br>通过创建一个代表tab的抽象类来开始着手构建tab抽象层，这个类是Actionbar.Tab接口的镜像:<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CompatTab</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> CompatTab <span class="title">setText</span><span class="params">(<span class="keyword">int</span> resId)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> CompatTab <span class="title">setIcon</span><span class="params">(<span class="keyword">int</span> resId)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> CompatTab <span class="title">setTabListener</span><span class="params">(</span><br><span class="line">            CompatTabListener callback)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> CompatTab <span class="title">setFragment</span><span class="params">(Fragment fragment)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> CharSequence <span class="title">getText</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Drawable <span class="title">getIcon</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> CompatTabListener <span class="title">getCallback</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Fragment <span class="title">getFragment</span><span class="params">()</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>在这里，为了简化诸如tab对象和Activity的联系（如下）等公共的功能，你可以使用一个抽象类而不是去使用接口。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Represents a single tab.</span><br><span class="line"> * The &#123;<span class="doctag">@link</span> TabHelper&#125; initializes one of the subclasses of this based</span><br><span class="line"> * on the current platform version, upon call to &#123;<span class="doctag">@link</span> TabHelper#newTab(String)&#125;()</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CompatTab</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> FragmentActivity mActivity;</span><br><span class="line">    <span class="keyword">final</span> String mTag;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">CompatTab</span><span class="params">(FragmentActivity activity, String tag)</span> </span>&#123;</span><br><span class="line">        mActivity = activity;</span><br><span class="line">        mTag = tag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> CompatTab <span class="title">setText</span><span class="params">(<span class="keyword">int</span> resId)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> CompatTab <span class="title">setIcon</span><span class="params">(<span class="keyword">int</span> resId)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> CompatTab <span class="title">setTabListener</span><span class="params">(CompatTabListener callback)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> CompatTab <span class="title">setFragment</span><span class="params">(Fragment fragment)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> CharSequence <span class="title">getText</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Drawable <span class="title">getIcon</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> CompatTabListener <span class="title">getCallback</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Fragment <span class="title">getFragment</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Object <span class="title">getTab</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTag</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mTag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>##抽象出Action Bar Tab的方法<br>下一步，定义一个能够允许你往Activity中创建和添加tab抽象类，并定义类似ActionBar.newTab())和ActionBar.addTab())的方法。<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TabHelper</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CompatTab <span class="title">newTab</span><span class="params">(String tag)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// This method is implemented in a later lesson.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">addTab</span><span class="params">(CompatTab tab)</span></span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>#代理至新的APIs<br>展示如何编写CompatTab和TabHelper等抽象类的子类，并且使用了较新的APIs。应用可以在支持这些新的APIs的平台版本的设备上使用这种实现方式。</p>
<p>##使用较新的APIs实现Tabs<br>CompatTab和TabHelper抽象类的具体子类<code>是一种代理实现</code>，它们使用了较新的APIs。由于抽象类在之前的定义并且是对新APIs接口（类结构、方法签名等等）的镜像，使用新APIs的具体子类只是简单的代理方法调用和方法调用的结果。(Since the abstract classes defined in the previous lesson mirror the new APIs (class structure, method signatures, etc.), the concrete classes that use these newer APIs simply proxy method calls and their results.)<br>可以在这些具体子类中直接使用较新的APIs，<code>由于使用延迟类加载的方式</code>，在早期版本的设备上并不会发生崩溃现象。<code>这些类在首次被访问（实例化类对象或者访问类的静态属性或静态方法）的时候才会去加载并初始化</code>。因此，只要你不在Honeycomb之前的设备上实例化Honeycomb相关的实现，dalvik虚拟机都不会抛出VerifyError异常。<br>对于本实现，一个比较好的命名约定是把具体子类需要的API等级或者版本名字附加在APIs接口的后边。例如，本地tab实现可以由CompatTabHoneycomb和TabHelperHoneycomb这两个类提供，名字后面附加Honeycomb是由于它们都依赖于Android 3.0（API等级11）之后版本的APIs。<br><img src="http://1.infotravel.sinaapp.com/pic/backward-compatible-ui-classes-honeycomb.png" alt="Honeycomb上tabs实现的类关系图"></p>
<p>##实现CompatTabHoneycomb<br>CompatTabHoneycomb是CompatTab抽象类的具体实现并用来引用单独的tabs。CompatTabHoneycomb只是简单的代理ActionBar.Tab对象的方法调用。 开始使用ActionBar.Tab的APIs实现CompatTabHoneycomb：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompatTabHoneycomb</span> <span class="keyword">extends</span> <span class="title">CompatTab</span> </span>&#123;</span><br><span class="line">    <span class="comment">// The native tab object that this CompatTab acts as a proxy for.</span></span><br><span class="line">    ActionBar.Tab mTab;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">CompatTabHoneycomb</span><span class="params">(FragmentActivity activity, String tag)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Proxy to new ActionBar.newTab API</span></span><br><span class="line">        mTab = activity.getActionBar().newTab();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CompatTab <span class="title">setText</span><span class="params">(<span class="keyword">int</span> resId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Proxy to new ActionBar.Tab.setText API</span></span><br><span class="line">        mTab.setText(resId);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Do the same for other properties (icon, callback, etc.)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>##实现TabHelperHoneycomb<br>TabHelperHoneycomb是TabHelper抽象类的具体实现，TabHelperHoneycomb代理方法调用到ActionBar对象，而这个ActionBar对象是从包含他的Activity中获取的。<br>实现TabHelperHoneycomb，代理其方法调用到ActionBar的API：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TabHelperHoneycomb</span> <span class="keyword">extends</span> <span class="title">TabHelper</span> </span>&#123;</span><br><span class="line">    ActionBar mActionBar;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mActionBar == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mActionBar = mActivity.getActionBar();</span><br><span class="line">            mActionBar.setNavigationMode(</span><br><span class="line">                    ActionBar.NAVIGATION_MODE_TABS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addTab</span><span class="params">(CompatTab tab)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Tab is a CompatTabHoneycomb instance, so its</span></span><br><span class="line">        <span class="comment">// native tab object is an ActionBar.Tab.</span></span><br><span class="line">        mActionBar.addTab((ActionBar.Tab) tab.getTab());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The other important method, newTab() is part of</span></span><br><span class="line">    <span class="comment">// the base implementation.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>#使用旧的APIs实现新API的效果<br>本节展示使用过旧的api实现新的api的效果</p>
<p>##使用替代的方法</p>
<ul>
<li>ActionBar可以使用水平的包含ImageButton的LinearLayout去实现或者使用<code>TabWidget</code>;</li>
<li><code>NumberPicker</code>和<code>Switch</code>控件可以使用<code>Spinner</code>和<code>ToggleButton</code>来代替;</li>
<li><code>ListPopupWindow</code>和<code>PopupMenu</code>控件可以使用<code>PopupWindow</code>控件代替。<br>##使用旧的api实现tabs<br>使用<code>TabWidget</code>和<code>TabHost</code>。<br>CompatTabEclair：<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompatTabEclair</span> <span class="keyword">extends</span> <span class="title">CompatTab</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Store these properties in the instance,</span></span><br><span class="line">    <span class="comment">// as there is no ActionBar.Tab object.</span></span><br><span class="line">    <span class="keyword">private</span> CharSequence mText;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CompatTab <span class="title">setText</span><span class="params">(<span class="keyword">int</span> resId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Our older implementation simply stores this</span></span><br><span class="line">        <span class="comment">// information in the object instance.</span></span><br><span class="line">        mText = mActivity.getResources().getText(resId);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Do the same for other properties (icon, callback, etc.)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>TabHelperEclair:<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TabHelperEclair</span> <span class="keyword">extends</span> <span class="title">TabHelper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> TabHost mTabHost;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mTabHost == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Our activity layout for pre-Honeycomb devices</span></span><br><span class="line">            <span class="comment">// must contain a TabHost.</span></span><br><span class="line">            mTabHost = (TabHost) mActivity.findViewById(</span><br><span class="line">                    android.R.id.tabhost);</span><br><span class="line">            mTabHost.setup();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addTab</span><span class="params">(CompatTab tab)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        TabSpec spec = mTabHost</span><br><span class="line">                .newTabSpec(tag)</span><br><span class="line">                .setIndicator(tab.getText()); <span class="comment">// And optional icon</span></span><br><span class="line">        ...</span><br><span class="line">        mTabHost.addTab(spec);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The other important method, newTab() is part of</span></span><br><span class="line">    <span class="comment">// the base implementation.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>#使用能感知版本的组件<br>既然对TabHelper和CompatTab已经有了两种具体实现，一个为Android 3.0和其后版本，一个为Android 3.0之前的版本。本节讨论创建在这两种实现之前切换的逻辑，创建能够感知版本的界面布局，最终使用我们创建的后向兼容的UI组件。</p>
<p>##添加切换逻辑<br>TabHelper抽象类基于当前设备的平台版本，<code>是用来创建适当版本的TabHelper和CompatTab实例的工厂类</code>：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TabHelper</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Usage is TabHelper.createInstance(activity)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> TabHelper <span class="title">createInstance</span><span class="params">(FragmentActivity activity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.HONEYCOMB) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> TabHelperHoneycomb(activity);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> TabHelperEclair(activity);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Usage is mTabHelper.newTab("tag")</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CompatTab <span class="title">newTab</span><span class="params">(String tag)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.HONEYCOMB) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> CompatTabHoneycomb(mActivity, tag);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> CompatTabEclair(mActivity, tag);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>##创建能感知版本的Activity布局<br>下一步是提供能够支持两种tab实现的Activity界面布局。对于老的实现（TabHelperEclair），你需要确保你的界面布局包含<code>TabWidget</code>和<code>TabHost</code>，同时存在一个包含tab内容的布局容器。<br>res/layout/main.xml:<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- This layout is for API level 5-10 only. --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">TabHost</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">android:id</span>=<span class="value">"@android:id/tabhost"</span></span><br><span class="line">    <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">    <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">LinearLayout</span></span><br><span class="line">        <span class="attribute">android:orientation</span>=<span class="value">"vertical"</span></span><br><span class="line">        <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">        <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">        <span class="attribute">android:padding</span>=<span class="value">"5dp"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">TabWidget</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@android:id/tabs"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="title">FrameLayout</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@android:id/tabcontent"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"0dp"</span></span><br><span class="line">            <span class="attribute">android:layout_weight</span>=<span class="value">"1"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">TabHost</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>对于TabHelperHoneycomb的实现，你唯一要做的就是一个包含tab内容的FrameLayout，这是由于ActionBar已经提供了tab相关的页面。</p>
<p>res/layout-v11/main.xml:<br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">FrameLayout</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">android:id</span>=<span class="value">"@android:id/tabcontent"</span></span><br><span class="line">    <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">    <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在运行的时候，Android将会根据平台版本去决定使用哪个版本的main.xml布局文件。这根上一节中选择哪一个版本的TabHelper所展示的逻辑是相同的。</p>
<p>##在Activity中使用TabHelper</p>
<p>在Activity的onCreate())方法中，你可以获得一个TabHelper对象，并且使用以下代码添加tabs：<br><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    setContentView(R.layout.main);</span><br><span class="line"></span><br><span class="line">    TabHelper tabHelper = TabHelper.createInstance(<span class="keyword">this</span>);</span><br><span class="line">    tabHelper.setUp();</span><br><span class="line"></span><br><span class="line">    CompatTab photosTab = tabHelper</span><br><span class="line">            .newTab(<span class="string">"photos"</span>)</span><br><span class="line">            .setText(R.string.tab_photos);</span><br><span class="line">    tabHelper.addTab(photosTab);</span><br><span class="line"></span><br><span class="line">    CompatTab videosTab = tabHelper</span><br><span class="line">            .newTab(<span class="string">"videos"</span>)</span><br><span class="line">            .setText(R.string.tab_videos);</span><br><span class="line">    tabHelper.addTab(videosTab);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当运行这个应用的时候，代码会自动显示对应的界面布局和实例化对应的TabHelperHoneycomb或TabHelperEclair对象，而实际使用的类对于Actvity来说是不透明的，因为它们拥有共同的TabHelper接口。</p>
<p>以下是这种实现运行在Android 2.3和Android 4.0上的界面截图：<br><img src="http://1.infotravel.sinaapp.com/pic/backward-compatible-ui-gb.png" alt="向后兼容的tabs运行在Android 2.3设备上"><br><img src="http://1.infotravel.sinaapp.com/pic/backward-compatible-ui-ics.png" alt="向后兼容的tabs运行在Android 4.0设备上"></p>
<p>#源码<br><a href="https://github.com/leerduo/TabCompat" target="_blank" rel="external">源代码</a></p>

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/UI-UE/" rel="tag">#UI/UE</a>
          
            <a href="/tags/移动开发/" rel="tag">#移动开发</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/06/30/training-for-the-eleventh-part/" rel="next" title="training for the eleventh part">
                <i class="fa fa-chevron-left"></i> training for the eleventh part
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/07/01/training-for-the-twelfth-part/" rel="prev" title="training for the twelfth part">
                training for the twelfth part <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2015/07/01/training-for-the-tenth-part/"
           data-title="training for the tenth part" data-url="http://chenfuduo.me/2015/07/01/training-for-the-tenth-part/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://duoinfo.sinaapp.com/yiyou/files/avatar.png"
               alt="chenfuduo" />
          <p class="site-author-name" itemprop="name">chenfuduo</p>
          <p class="site-description motion-element" itemprop="description">移动开发者,极端产品控。</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">76</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">6</span>
              <span class="site-state-item-name">分类</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            
              <span class="site-state-item-count">13</span>
              <span class="site-state-item-name">标签</span>
              
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/leerduo" target="_blank">
                  
                    <i class="fa fa-globe"></i> github
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/duoduoustc" target="_blank">
                  
                    <i class="fa fa-globe"></i> weibo
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
                <a href="http://www.vogella.com/tutorials/android.html" target="_blank">Vogella</a>
              </span>
            
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <p class="post-toc-empty">此文章未包含目录</p>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chenfuduo</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  
  
<script type="text/javascript" src="/js/src/scrollspy.js?v=0.5.0"></script>

<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = NexT.utils.escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    NexT.motion.middleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');

      if (CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          NexT.utils.displaySidebar();
        }
      }
    };
  });
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"chenfuduo"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  

  
  


</body>
</html>
